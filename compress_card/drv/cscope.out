cscope 15 $HOME/百度云同步盘/压缩卡/压缩卡/src/compress_card/drv -q 0000000211 0000010588
	@VisualDDKHelpers.h

1 #agm



12 #ifde
_DEBUG


14 
	~<ext.h
>

15 
	~<def.h
>

17 
	eNTSTATUS_VisuDDK_Hr
 {} 
	gNTSTATUS_VisuDDK_Hr_t
;

18 
C_ASSERT
((
NTSTATUS_VisuDDK_Hr_t
=(
NTSTATUS
));

20 
	#NTSTATUS
 
NTSTATUS_VisuDDK_Hr_t


	)

22 
HANDLE_VisuDDK_Hr
 *
	tHANDLE_VisuDDK_Hr_t
, **
	tPHANDLE_VisuDDK_Hr_t
;

23 
C_ASSERT
((
HANDLE_VisuDDK_Hr_t
=(
HANDLE
));

24 
C_ASSERT
((
PHANDLE_VisuDDK_Hr_t
=(
PHANDLE
));

26 
	#HANDLE
 
HANDLE_VisuDDK_Hr_t


	)

27 
	#PHANDLE
 
PHANDLE_VisuDDK_Hr_t


	)

	@drv.cpp

1 
	~"dafx.h
"

22 
drvUd
(
IN
 
PDRIVER_OBJECT
 
DrivObje
);

23 
NTSTATUS
 
drvCeClo
(
IN
 
PDEVICE_OBJECT
 
DeviObje
, IN 
PIRP
 
I
);

24 
NTSTATUS
 
drvDeuHdr
(
IN
 
PDEVICE_OBJECT
 
DeviObje
, IN 
PIRP
 
I
);

25 
NTSTATUS
 
drvAddDevi
(
IN
 
PDRIVER_OBJECT
 
DrivObje
, IN 
PDEVICE_OBJECT
 
PhysilDeviObje
);

26 
NTSTATUS
 
drvPnP
(
IN
 
PDEVICE_OBJECT
 
DeviObje
, IN 
PIRP
 
I
);

27 
NTSTATUS
 
drvRd
(
IN
 
PDEVICE_OBJECT
 
DeviObje
, IN 
PIRP
 
I
);

29 
	s_deviExnsi


31 
PDEVICE_OBJECT
 
	mDeviObje
;

32 
PDEVICE_OBJECT
 
	mTgDeviObje
;

33 
PDEVICE_OBJECT
 
	mPhysilDeviObje
;

34 
UNICODE_STRING
 
	mDeviI
;

36 
PIRP
 
	mI
;

37 
KSPIN_LOCK
 
	mSpI
;

38 
KEVENT
 
	mRdEvt
;

39 } 
	tdrv_DEVICE_EXTENSION
, *
	tPdrv_DEVICE_EXTENSION
;

42 cڡ 
GUID
 
	gGUID_drvI
 = {0xAC1F07, 0x61bb, 0x4a65, {0x9c, 0x83, 0x68, 0x98, 0xb3, 0x80, 0x2d, 0xd0 } };

44 #ifde
__lulus


45 "C" 
NTSTATUS
 
DrivEry
(
IN
 
PDRIVER_OBJECT
 
DrivObje
, IN 
PUNICODE_STRING
 
RegiryPh
);

48 
NTSTATUS
 
	$DrivEry
(
IN
 
PDRIVER_OBJECT
 
DrivObje
, IN 
PUNICODE_STRING
 
RegiryPh
)

50 
i
;

52 
i
 = 0; i <
IRP_MJ_MAXIMUM_FUNCTION
; i++)

53 
DrivObje
->
MajFuni
[
i
] = 
drvDeuHdr
;

55 
DrivObje
->
MajFuni
[
IRP_MJ_CREATE
] = 
drvCeClo
;

56 
DrivObje
->
MajFuni
[
IRP_MJ_CLOSE
] = 
drvCeClo
;

57 
DrivObje
->
MajFuni
[
IRP_MJ_PNP
] = 
drvPnP
;

60 
DrivObje
->
DrivUd
 = 
drvUd
;

61 
DrivObje
->
DrivSIo
 = 
NULL
;

62 
DrivObje
->
DrivExnsi
->
AddDevi
 = 
drvAddDevi
;

64  
STATUS_SUCCESS
;

65 
	}
}

67 
	$drvUd
(
IN
 
PDRIVER_OBJECT
 
DrivObje
)

69 
	}
}

71 
NTSTATUS
 
	$drvCeClo
(
IN
 
PDEVICE_OBJECT
 
DeviObje
, IN 
PIRP
 
I
)

73 
I
->
IoStus
.
Stus
 = 
STATUS_SUCCESS
;

74 
I
->
IoStus
.
Infmi
 = 0;

75 
	`IoComeReque
(
I
, 
IO_NO_INCREMENT
);

76  
STATUS_SUCCESS
;

77 
	}
}

79 
NTSTATUS
 
	$drvDeuHdr
(
IN
 
PDEVICE_OBJECT
 
DeviObje
, IN 
PIRP
 
I
)

81 
Pdrv_DEVICE_EXTENSION
 
deviExnsi
 = 
NULL
;

83 
	`IoSkCutISckLoti
(
I
);

84 
deviExnsi
 = (
Pdrv_DEVICE_EXTENSION

DeviObje
->
DeviExnsi
;

85  
	`IoClDriv
(
deviExnsi
->
TgDeviObje
, 
I
);

86 
	}
}

88 
NTSTATUS
 
	$drvAddDevi
(
IN
 
PDRIVER_OBJECT
 
DrivObje
, IN 
PDEVICE_OBJECT
 
PhysilDeviObje
)

90 
PDEVICE_OBJECT
 
DeviObje
 = 
NULL
;

91 
Pdrv_DEVICE_EXTENSION
 
pExnsi
 = 
NULL
;

92 
NTSTATUS
 
us
;

94 
us
 = 
	`IoCeDevi
(
DrivObje
,

95 (
drv_DEVICE_EXTENSION
),

96 
NULL
,

97 
FILE_DEVICE_UNKNOWN
,

98 
FILE_DEVICE_SECURE_OPEN
,

99 
TRUE
,

100 &
DeviObje
);

102 i(!
	`NT_SUCCESS
(
us
))

103  
us
;

105 
pExnsi
 = (
Pdrv_DEVICE_EXTENSION
)
DeviObje
->
DeviExnsi
;

107 
pExnsi
->
DeviObje
 = DeviceObject;

108 
pExnsi
->
PhysilDeviObje
 = PhysicalDeviceObject;

109 
pExnsi
->
TgDeviObje
 = 
	`IoAachDeviToDeviSck
(
DeviObje
, 
PhysilDeviObje
);

111 
pExnsi
->
I
 = 
NULL
;

112 
	`KeInlizeSpLock
(&
pExnsi
->
SpI
);

113 
	`KeInlizeEvt
(&
pExnsi
->
RdEvt
, 
SynchriziEvt
, 
FALSE
);

115 
us
 = 
	`IoRegiDeviI
(
PhysilDeviObje
, &
GUID_drvI
, 
NULL
, &
pExnsi
->
DeviI
);

116 
	`ASSERT
(
	`NT_SUCCESS
(
us
));

118 
DeviObje
->
Fgs
 &~
DO_DEVICE_INITIALIZING
;

119 
DeviObje
->
Fgs
 |
DO_DIRECT_IO
;

121  
STATUS_SUCCESS
;

122 
	}
}

125 
NTSTATUS
 
	$drvIComi
(

126 
IN
 
PDEVICE_OBJECT
 
DeviObje
,

127 
IN
 
PIRP
 
I
,

128 
IN
 
PVOID
 
Cڋxt


131 
PKEVENT
 
Evt
 = (PKEVENT
Cڋxt
;

133 
	`UNREFERENCED_PARAMETER
(
DeviObje
);

134 
	`UNREFERENCED_PARAMETER
(
I
);

136 
	`KeSEvt
(
Evt
, 
IO_NO_INCREMENT
, 
FALSE
);

138 (
STATUS_MORE_PROCESSING_REQUIRED
);

139 
	}
}

141 
NTSTATUS
 
	$drvFwdISynchrous
(

142 
IN
 
PDEVICE_OBJECT
 
DeviObje
,

143 
IN
 
PIRP
 
I


146 
Pdrv_DEVICE_EXTENSION
 
deviExnsi
;

147 
KEVENT
 
evt
;

148 
NTSTATUS
 
us
;

150 
	`KeInlizeEvt
(&
evt
, 
NifitiEvt
, 
FALSE
);

151 
deviExnsi
 = (
Pdrv_DEVICE_EXTENSION

DeviObje
->
DeviExnsi
;

153 
	`IoCyCutISckLotiToNext
(
I
);

155 
	`IoSComiRoute
(
I
, 
drvIComi
, &
evt
, 
TRUE
, TRUE, TRUE);

157 
us
 = 
	`IoClDriv
(
deviExnsi
->
TgDeviObje
, 
I
);

159 i(
us
 =
STATUS_PENDING
) {

160 
	`KeWaFSgObje
(&
evt
, 
Executive
, 
KlMode
, 
FALSE
, 
NULL
);

161 
us
 = 
I
->
IoStus
.
Stus
;

163  
us
;

164 
	}
}

166 
NTSTATUS
 
	$drvPnP
(
IN
 
PDEVICE_OBJECT
 
DeviObje
, IN 
PIRP
 
I
)

168 
PIO_STACK_LOCATION
 
pSp
 = 
	`IoGCutISckLoti
(
I
);

169 
Pdrv_DEVICE_EXTENSION
 
pExt
 = ((Pdrv_DEVICE_EXTENSION)
DeviObje
->
DeviExnsi
);

170 
NTSTATUS
 
us
;

172 
	`ASSERT
(
pExt
);

174 
pSp
->
MFuni
)

176 
IRP_MN_START_DEVICE
:

177 
us
 = 
	`drvFwdISynchrous
(
DeviObje
, 
I
);

178 if(
	`NT_SUCCESS
(
us
))

180 
us
 = 
	`drvRdPciCfig
(
pExt
, 
pSp
);

181 if(
	`NT_SUCCESS
(
us
))

183 
	`IoSDeviIS
(&
pExt
->
DeviI
, 
TRUE
);

187 
I
->
IoStus
.
Stus
 = 
STATUS_SUCCESS
;

188 
	`IoComeReque
(
I
, 
IO_NO_INCREMENT
);

189  
STATUS_SUCCESS
;

191 
IRP_MN_QUERY_REMOVE_DEVICE
:

192 
I
->
IoStus
.
Stus
 = 
STATUS_SUCCESS
;

193 
	`IoComeReque
(
I
, 
IO_NO_INCREMENT
);

194  
STATUS_SUCCESS
;

196 
IRP_MN_REMOVE_DEVICE
:

197 
	`IoSDeviIS
(&
pExt
->
DeviI
, 
FALSE
);

198 
us
 = 
	`drvFwdISynchrous
(
DeviObje
, 
I
);

199 
	`IoDachDevi
(
pExt
->
TgDeviObje
);

200 
	`IoDeDevi
(
pExt
->
DeviObje
);

201 
	`RFeUnicodeSg
(&
pExt
->
DeviI
);

202 
I
->
IoStus
.
Stus
 = 
STATUS_SUCCESS
;

203 
	`IoComeReque
(
I
, 
IO_NO_INCREMENT
);

204  
STATUS_SUCCESS
;

206 
IRP_MN_QUERY_PNP_DEVICE_STATE
:

207 
us
 = 
	`drvFwdISynchrous
(
DeviObje
, 
I
);

208 
I
->
IoStus
.
Infmi
 = 0;

209 
	`IoComeReque
(
I
, 
IO_NO_INCREMENT
);

210  
us
;

212  
	`drvDeuHdr
(
DeviObje
, 
I
);

213 
	}
}

215 
NTSTATUS
 
	$drvRd
(
IN
 
PDEVICE_OBJECT
 
DeviObje
, IN 
PIRP
 
I
)

217 
I
->
IoStus
.
Stus
 = 
STATUS_SUCCESS
;

218 
I
->
IoStus
.
Infmi
 = 0;

219 
	`IoComeReque
(
I
, 
IO_NO_INCREMENT
);

220  
STATUS_SUCCESS
;

221 
	}
}

223 
NTSTATUS
 
	$drvRdPciCfig
(
IN
 
Pdrv_DEVICE_EXTENSION
 
pDevExt
, IN 
PIO_STACK_LOCATION
 
pISck
)

225 
i
;

226 
ULONG
 
dex
;

227 
ULONG
 
cou
;

228 
PCM_RESOURCE_LIST
 
pResourLi
, 
pResourLiTned
;

229 
PCM_PARTIAL_RESOURCE_LIST
 
l
, 
lTned
;

230 
PCM_PARTIAL_RESOURCE_DESCRIPTOR
 
d
, 
dTned
;

231 
PCM_FULL_RESOURCE_DESCRIPTOR
 
d
, 
dTned
;

232 
ULONG
 
NumCou
;

233 
NTSTATUS
 
us
 = 
STATUS_SUCCESS
;

234 
DEVICE_DESCRIPTION
 
DeviDesti
;

235 
INTERFACE_TYPE
 
BusTy
;

236 
ULONG
 
Junk
;

238 
PUCHAR
 
pBaMem0
, 
pBaMem2
;

239 
ULONG
 
vue
 = 0;

240 
ULONG
 
iC
 = 0;

244 
pResourLiTned
 = 
pISck
->
Pams
.
SDevi
.
AodResoursTned
;

245 if(
pResourLiTned
 =
NULL
|| (pResourLiTned->
Cou
 == 0) )

247  (
STATUS_INSUFFICIENT_RESOURCES
);

249 
dTned
 = &
pResourLiTned
->
Li
[0];

250 
lTned
 = &
dTned
->
PtlResourLi
;

251 
dTned
 = 
lTned
->
PtlDests
;

252 
NumCou
 = 
lTned
->
Cou
;

253 
cou
 = 0;

254 
dex
=0; index<
NumCou
 ; 
dTned
++,index++ )

256 
dTned
->
Ty
)

259 
CmResourTyPt
:

260 
pDevExt
->
ba
[
cou
].
IoPtSize
 = 
dTned
->
u
.
Pt
.
Lgth
;

261 
pDevExt
->
ba
[
cou
].
IoPtMdAddss
 = (
PVOID
)
dTned
->
u
.
Pt
.
S
.
LowPt
;

262 
pDevExt
->
ba
[
cou
].
WhichMd
 = 
TYPE_IO
;

263 
cou
++;

266 
CmResourTyMemy
:

267 
pDevExt
->
ba
[
cou
].
MemySize
 = 
dTned
->
u
.
Memy
.
Lgth
;

268 
pDevExt
->
ba
[
cou
].
MemyRegiAddss
 = 
dTned
->
u
.
Memy
.
S
;

269 
pDevExt
->
ba
[
cou
].
MemyMdAddss
 = 
	`MmMIoS

dTned
->
u
.
Memy
.
S
,rdTned->u.Memy.
Lgth
, 
MmNCached
);

270 
pDevExt
->
ba
[
cou
].
WhichMd
 = 
TYPE_MEM
;

271 
cou
++;

274 
CmResourTyIru
:

275 
pDevExt
->
IruLev
 = (
KIRQL
)
dTned
->
u
.
Iru
.
Lev
;

276 
pDevExt
->
IruVe
 = 
dTned
->
u
.
Iru
.
Ve
;

277 
pDevExt
->
IruAffy
 = 
dTned
->
u
.
Iru
.
Affy
;

278 
pDevExt
->
IruMode
 = (
dTned
->
Fgs
 =
CM_RESOURCE_INTERRUPT_LATCHED
? 
Lched
 : 
LevSsive
;

279 
pDevExt
->
IruShe
 = (
dTned
->
SheDiosi
 =
CmResourSheShed
);

280 
pDevExt
->
IruSut
 = 1;

283 
CmResourTyDma
:

286 
CmResourTyBusNumb
:

293 i
cou
 == 0 )

295  (
STATUS_UNSUCCESSFUL
);

300 
PCI_SLOT_NUMBER
 
_numb
;

301 
	`IoGDeviPrݔty

pDevExt
->
PhysilDeviObje
, 
DeviPrݔtyAddss
, (
ULONG
), &
_numb
, &
Junk
);

302 
pDevExt
->
SlNumb
 = (
_numb
.
u
.
AsULONG
 >> 16);

307 
PCI_SLOT_NUMBER
 
_numb
;

308 
	`IoGDeviPrݔty

pDevExt
->
PhysilDeviObje
, 
DeviPrݔtyBusNumb
, (
ULONG
), &
_numb
, &
Junk
);

309 
pDevExt
->
BusNumb
 = (
_numb
.
u
.
AsULONG
);

335 if(
pDevExt
->
IruSut
 != 0)

339 
	`IoInlizeDpcReque
(
pDevExt
->
FuniڮDeviObje
, 
DpcFI
);

344 
us
 = 
	`IoCIruEx
&
pDevExt
->
IruObje
,

345 (
PKSERVICE_ROUTINE
)
IruHdr
,

346 
pDevExt
,

347 
NULL
,

348 
pDevExt
->
IruVe
,

349 
pDevExt
->
IruLev
,

350 
pDevExt
->
IruLev
,

351 
pDevExt
->
IruMode
,

352 
pDevExt
->
IruShe
,

353 
pDevExt
->
IruAffy
,

354 
FALSE
 );

355 if!
	`NT_SUCCESS
(
us
) )

357 (
us
);

366  (
STATUS_SUCCESS
);

367 
	}
}

	@stdafx.cpp

2 
	~"dafx.h
"

	@stdafx.h

1 #ide
_WIN32_WINNT


2 
	#_WIN32_WINNT
 0x0501

4 

	)

5 #ifde
__lulus


11 
	~"VisuDDKHrs.h
"

12 
	~<ddk.h
>

13 
	~<dd.h
>

14 
	~<moudev.h
>

15 
	~<ddv.h
>

16 
	~<ifs.h
>

19 #ifde
__lulus


	@
1
.
0
4
47
VisualDDKHelpers.h
drv.cpp
stdafx.cpp
stdafx.h
